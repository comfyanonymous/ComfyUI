{"version":3,"file":"userSelection-Dh-tiIjz.js","sources":["../../src/scripts/ui/userSelection.ts"],"sourcesContent":["import { api } from '../api'\nimport { $el } from '../ui'\nimport { createSpinner } from './spinner'\nimport './userSelection.css'\n\ninterface SelectedUser {\n  username: string\n  userId: string\n  created: boolean\n}\n\nexport class UserSelectionScreen {\n  async show(users, user): Promise<SelectedUser> {\n    const userSelection = document.getElementById('comfy-user-selection')\n    userSelection.style.display = ''\n    return new Promise((resolve) => {\n      const input = userSelection.getElementsByTagName('input')[0]\n      const select = userSelection.getElementsByTagName('select')[0]\n      const inputSection = input.closest('section')\n      const selectSection = select.closest('section')\n      const form = userSelection.getElementsByTagName('form')[0]\n      const error = userSelection.getElementsByClassName('comfy-user-error')[0]\n      const button = userSelection.getElementsByClassName(\n        'comfy-user-button-next'\n      )[0]\n\n      let inputActive = null\n      input.addEventListener('focus', () => {\n        inputSection.classList.add('selected')\n        selectSection.classList.remove('selected')\n        inputActive = true\n      })\n      select.addEventListener('focus', () => {\n        inputSection.classList.remove('selected')\n        selectSection.classList.add('selected')\n        inputActive = false\n        select.style.color = ''\n      })\n      select.addEventListener('blur', () => {\n        if (!select.value) {\n          select.style.color = 'var(--descrip-text)'\n        }\n      })\n\n      form.addEventListener('submit', async (e) => {\n        e.preventDefault()\n        if (inputActive == null) {\n          error.textContent =\n            'Please enter a username or select an existing user.'\n        } else if (inputActive) {\n          const username = input.value.trim()\n          if (!username) {\n            error.textContent = 'Please enter a username.'\n            return\n          }\n\n          // Create new user\n          // Property 'readonly' does not exist on type 'HTMLSelectElement'.ts(2339)\n          // Property 'readonly' does not exist on type 'HTMLInputElement'. Did you mean 'readOnly'?ts(2551)\n          input.disabled =\n            select.disabled =\n            // @ts-expect-error\n            input.readonly =\n            // @ts-expect-error\n            select.readonly =\n              true\n          const spinner = createSpinner()\n          button.prepend(spinner)\n          try {\n            const resp = await api.createUser(username)\n            if (resp.status >= 300) {\n              let message =\n                'Error creating user: ' + resp.status + ' ' + resp.statusText\n              try {\n                const res = await resp.json()\n                if (res.error) {\n                  message = res.error\n                }\n              } catch (error) {}\n              throw new Error(message)\n            }\n\n            resolve({ username, userId: await resp.json(), created: true })\n          } catch (err) {\n            spinner.remove()\n            error.textContent =\n              err.message ??\n              err.statusText ??\n              err ??\n              'An unknown error occurred.'\n            // Property 'readonly' does not exist on type 'HTMLSelectElement'.ts(2339)\n            // Property 'readonly' does not exist on type 'HTMLInputElement'. Did you mean 'readOnly'?ts(2551)\n            input.disabled =\n              select.disabled =\n              // @ts-expect-error\n              input.readonly =\n              // @ts-expect-error\n              select.readonly =\n                false\n            return\n          }\n        } else if (!select.value) {\n          error.textContent = 'Please select an existing user.'\n          return\n        } else {\n          resolve({\n            username: users[select.value],\n            userId: select.value,\n            created: false\n          })\n        }\n      })\n\n      if (user) {\n        const name = localStorage['Comfy.userName']\n        if (name) {\n          input.value = name\n        }\n      }\n      if (input.value) {\n        // Focus the input, do this separately as sometimes browsers like to fill in the value\n        input.focus()\n      }\n\n      const userIds = Object.keys(users ?? {})\n      if (userIds.length) {\n        for (const u of userIds) {\n          $el('option', { textContent: users[u], value: u, parent: select })\n        }\n        select.style.color = 'var(--descrip-text)'\n\n        if (select.value) {\n          // Focus the select, do this separately as sometimes browsers like to fill in the value\n          select.focus()\n        }\n      } else {\n        userSelection.classList.add('no-users')\n        input.focus()\n      }\n    }).then((r: SelectedUser) => {\n      userSelection.remove()\n      return r\n    })\n  }\n}\n"],"names":["error"],"mappings":"oiBAWO,MAAM,qBAAN,MAAM,oBAAoB,CACzB,KAAK,MAAO,KAA6B,sCACvC,MAAA,cAAgB,SAAS,eAAe,sBAAsB,EACpE,qBAAc,MAAM,QAAU,GACvB,IAAI,QAAS,SAAY,CAC9B,MAAM,MAAQ,cAAc,qBAAqB,OAAO,EAAE,CAAC,EACrD,OAAS,cAAc,qBAAqB,QAAQ,EAAE,CAAC,EACvD,aAAe,MAAM,QAAQ,SAAS,EACtC,cAAgB,OAAO,QAAQ,SAAS,EACxC,KAAO,cAAc,qBAAqB,MAAM,EAAE,CAAC,EACnD,MAAQ,cAAc,uBAAuB,kBAAkB,EAAE,CAAC,EAClE,OAAS,cAAc,uBAC3B,0BACA,CAAC,EAEH,IAAI,YAAc,KAuFlB,GAtFM,MAAA,iBAAiB,QAAS,IAAM,CACvB,aAAA,UAAU,IAAI,UAAU,EACvB,cAAA,UAAU,OAAO,UAAU,EAC3B,YAAA,EAAA,CACf,EACM,OAAA,iBAAiB,QAAS,IAAM,CACxB,aAAA,UAAU,OAAO,UAAU,EAC1B,cAAA,UAAU,IAAI,UAAU,EACxB,YAAA,GACd,OAAO,MAAM,MAAQ,EAAA,CACtB,EACM,OAAA,iBAAiB,OAAQ,IAAM,CAC/B,OAAO,QACV,OAAO,MAAM,MAAQ,sBACvB,CACD,EAEI,KAAA,iBAAiB,SAAiB,GAAM,2CAE3C,GADA,EAAE,eAAe,EACb,aAAe,KACjB,MAAM,YACJ,8DACO,YAAa,CAChB,MAAA,SAAW,MAAM,MAAM,KAAK,EAClC,GAAI,CAAC,SAAU,CACb,MAAM,YAAc,2BACpB,MACF,CAKA,MAAM,SACJ,OAAO,SAEP,MAAM,SAEN,OAAO,SACL,GACJ,MAAM,QAAU,gBAChB,OAAO,QAAQ,OAAO,EAClB,GAAA,CACF,MAAM,KAAO,MAAM,IAAI,WAAW,QAAQ,EACtC,GAAA,KAAK,QAAU,IAAK,CACtB,IAAI,QACF,wBAA0B,KAAK,OAAS,IAAM,KAAK,WACjD,GAAA,CACI,MAAA,IAAM,MAAM,KAAK,OACnB,IAAI,QACN,QAAU,IAAI,aAETA,OAAO,CAAC,CACX,MAAA,IAAI,MAAM,OAAO,CACzB,CAEQ,QAAA,CAAE,SAAU,OAAQ,MAAM,KAAK,OAAQ,QAAS,EAAA,CAAM,QACvD,IAAK,CACZ,QAAQ,OAAO,EACf,MAAM,aACJ,eAAI,UAAJ,QACA,IAAI,aADJ,QAEA,MAFA,QAGA,6BAGF,MAAM,SACJ,OAAO,SAEP,MAAM,SAEN,OAAO,SACL,GACJ,MACF,CAAA,SACU,OAAO,MAIT,QAAA,CACN,SAAU,MAAM,OAAO,KAAK,EAC5B,OAAQ,OAAO,MACf,QAAS,EAAA,CACV,MARuB,CACxB,MAAM,YAAc,kCACpB,MAAA,CAOF,EACD,EAEG,KAAM,CACF,MAAA,KAAO,aAAa,gBAAgB,EACtC,OACF,MAAM,MAAQ,KAElB,CACI,MAAM,OAER,MAAM,MAAM,EAGd,MAAM,QAAU,OAAO,KAAK,kBAAS,CAAE,CAAA,EACvC,GAAI,QAAQ,OAAQ,CAClB,UAAW,KAAK,QACV,IAAA,SAAU,CAAE,YAAa,MAAM,CAAC,EAAG,MAAO,EAAG,OAAQ,MAAQ,CAAA,EAEnE,OAAO,MAAM,MAAQ,sBAEjB,OAAO,OAET,OAAO,MAAM,CACf,MAEc,cAAA,UAAU,IAAI,UAAU,EACtC,MAAM,MAAM,CACd,CACD,EAAE,KAAM,IACP,cAAc,OAAO,EACd,EACR,CACH,GACF,EArIiC,mDAA1B,IAAM,oBAAN"}